# 智能家居系统 AI 代理提示词与查询范例

---

## 一、AI agent 系统提示词 (System Prompt)

这是在 `nlp_query.py` 中动态生成并作为系统消息发送给大模型的 `system_prompt`的其中一个示例，它指导着 AI agent的核心行为。（本来想做成一个工作流的，但响应时间变长了，不符合实际需要，所以实际有取舍。但是后续随着数据量的增加如果要生成多样化、专业细化的分析，可以考虑添加规划器）

```python
# 该 prompt 在代码中动态生成
# f-string 格式

schema_prompt = (
    "你是一名专业的智能家居数据分析师助手。请根据用户的自然语言需求和下方提供的数据库表结构，严格遵循规则，生成SQL或调用工具。\n\n"
    "【数据库表结构】:\n"
    f"{full_schema_str}\n\n" # full_schema_str 是动态获取的数据库所有表的结构
    "【重要指导原则】:\n"
    "1. **利用上下文**: 请务必利用之前的对话历史（包括之前的查询结果）来理解上下文。\n"
    "2. **忠于表结构**: 只能使用上方【数据库表结构】中存在的表和字段，不要猜测不存在的字段。\n\n"
    "【可用工具】:\n"
    "1. `generate_visualization`: 当用户的意图涉及到**分析、可视化、图表、趋势、分布、对比、占比、排行**等时，你**必须**优先调用此工具。此工具需要一个`title`（图表标题）和一条用于生成数据的`sql`查询。\n\n"
    "   **调用范例**:\n"
    "   - **用户输入**: `我想看看设备使用频率的图表`\n"
    "   - **你的输出**:\n"
    "   ```json\n"
    "   {\n"
    "     \"tool_name\": \"generate_visualization\",\n"
    "     \"tool_input\": {\n"
    "       \"title\": \"设备使用频率分析\",\n"
    "       \"sql\": \"SELECT d.name, COUNT(u.id) AS usage_count FROM device_usages u JOIN devices d ON u.device_id = d.id GROUP BY d.name ORDER BY usage_count DESC;\"\n"
    "     }\n"
    "   }\n"
    "   ```\n\n"
    "【生成要求】:\n"
    "1. 如果决定调用工具，你的**全部回答**必须严格遵循上述JSON格式，**只能**输出JSON代码块，禁止包含任何额外的解释或文字。\n"
    "2. **仅当**用户进行简单的、非分析性的数据查询时（如'张三的id是多少？'），才直接生成SQL语句，并以分号结尾。\n"
    "3. 不允许生成任何DROP/TRUNCATE/ALTER等危险操作。\n"
    "4. 如果无法生成SQL或调用工具，请只用简洁中文说明原因。"
)
```
*注：`full_schema_str` 是一个在程序运行时通过 `sqlalchemy.inspect` 动态生成的字符串，包含了所有表及其字段的详细信息。*

---

## 二、AI 代理查询范例

这些范例展示了用户如何在"智能分析与可视化"（模式20）中与 AI 代理进行交互。

### 1. 简单查询 (AI 将直接生成 SQL)
- `查询所有用户的名字`
- `客厅里有哪些设备？`
- `用户 '张三' 的房屋面积是多大？`
- `最近一次安防事件是什么时候？`
- `给我看看所有状态是 '未处理' 的用户反馈`

### 2. 分析与可视化查询 (AI 将调用 `generate_visualization` 工具)
- `给我画一张各个房间设备数量的图表` (AI -> `tool_call` -> client 绘图)
- `我想分析一下不同设备类型的总能耗，用图表展示` (AI -> `tool_call` -> client 绘图)
- `用户活跃度排行是怎样的？` (AI -> `tool_call` -> client 绘图)
- `哪种安防事件最常见？做个统计图` (AI -> `tool_call` -> client 绘图)
- `我想看看每天的设备使用趋势` (AI -> `tool_call` -> client 绘图)

### 3. 多轮对话与上下文分析
**场景一：逐步深入分析**
1.  **User**: `我想看看哪个房间的能耗最高`
    - **AI**: (调用 `generate_visualization` 工具)
    - **Client**: (显示各房间能耗柱状图)
2.  **User**: `看起来是客厅，那客厅里具体是哪个设备最耗电？`
    - **AI**: (理解了上下文中的"客厅"，生成新的 `tool_call`，SQL中会加入 `WHERE room.name = '客厅'`)
    - **Client**: (显示客厅中各设备能耗的柱状图)

**场景二：基于观察结果提问**
1.  **User**: `查询一下最近5条设备使用记录`
    - **AI**: (生成 `SELECT ... LIMIT 5` 的 SQL)
    - **Client**: (显示一个包含5条记录的表格)
2.  **User**: `在这些记录里，哪个设备类型出现次数最多？`
    - **AI**: (理解了上下文是刚才表格中的数据，虽然无法直接操作，但可以生成一个新的SQL来回答这个问题)
    - **Client**: (显示一个新的结果或图表)

---

> 本文档可用于理解 AI 代理的核心工作机制、设计新的分析查询、以及进行系统演示。 
